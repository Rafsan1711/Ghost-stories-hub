<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Ghost Stories Hub</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  <link rel="icon" type="image/png" href="favicon.png">
  <style>
    * { margin:0; padding:0; box-sizing:border-box; font-family: sans-serif; }
    body {
      background: #121212;
      color: #eee;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      padding: 20px;
    }
    /* Mobile-screen container */
    #login-screen {
      position: relative;
      width: min(400px, 90vw);
      height: 70vh; /* আগের aspect-ratio বাদ দিয়ে উচ্চতা বাড়ানো */
      background: url('signin.png') center/cover no-repeat;
      display: flex;
      justify-content: center;
      align-items: center;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.5);
    }
    #login-btn {
      padding: 12px 20px;
      background: rgba(255,255,255,0.9);
      color: #121212;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
    }
    /* App container */
    #app, #profile-view {
      display: none;
      width: 100%;
      max-width: 800px;
      margin-top: 20px;
    }
    .section {
      background: #1e1e1e;
      padding: 16px;
      border-radius: 12px;
      margin-bottom: 16px;
      position: relative;
    }
    /* Header layout: column with title, subtitle, then buttons */
    .header {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 24px 16px;
    }
    .header h1 {
      font-family: 'Creepster', cursive;
      font-size: 2.5rem;
      text-align: center;
      margin-bottom: 8px;
    }
    .header h2 {
      font-family: 'Creepster', cursive;
      font-size: 1.25rem;
      text-align: center;
      opacity: 0.9;
      margin-top: 0;
      margin-bottom: 12px;
    }
    .header-buttons {
      display: flex;
      gap: 16px;
      margin-top: 0;
      margin-bottom: 16px;
    }
    #logout-btn {
      background: #1976d2;
      color: #fff;
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    #notification-btn {
      background: none;
      color: #ccc;
      padding: 6px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    #posts, #profile-posts { }
    .post {
      background: #2a2a2a;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 12px;
      position: relative;
    }
    .post .username {
      font-weight: bold;
      cursor: pointer;
      margin-bottom: 6px;
    }
    .post h3 {
      margin: 0 0 6px 0;
    }
    .post p {
      margin: 0;
    }
    /* Post footer: comments & likes */
    .post-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 12px;
      padding-top: 8px;
      border-top: 1px solid #3a3a3a;
      gap: 12px;
    }
    .post-footer button {
      background: none;
      border: none;
      color: #90caf9;
      cursor: pointer;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .post-footer .like-btn.active svg { fill: #e91e63; }
    /* Post a story button */
    #post-story-btn {
      display: block;
      background: #333;
      color: #eee;
      border: none;
      padding: 10px 16px;
      margin: 0 auto 16px;
      border-radius: 8px;
      cursor: pointer;
    }
    /* Modal overlay common */
    .modal-overlay {
      position: fixed; top:0; left:0; right:0; bottom:0;
      background: rgba(0,0,0,0.7);
      display: none; justify-content:center; align-items:center;
      z-index: 100;
    }
    /* Story modal */
    #story-modal {
      background: #1f1f1f;
      padding: 20px;
      border-radius: 12px;
      width: 90%;
      max-width: 400px;
    }
    #story-modal input, #story-modal textarea {
      width: 100%; padding: 8px; margin-bottom: 12px;
      border: none; border-radius: 6px; background: #2a2a2a; color: #eee;
    }
    #story-modal button {
      padding: 8px 14px; border:none; border-radius:6px; cursor:pointer;
      background: #444; color:#fff;
    }
    /* Comments modal */
    #comments-overlay.modal-overlay { align-items: flex-start; padding-top: 40px; }
    #comments-modal {
      background: #1f1f1f;
      padding: 20px;
      border-radius: 12px;
      width: 90%;
      max-width: 500px;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
      position: relative;
    }
    #comments-modal h3 {
      text-align: center;
      margin-bottom: 12px;
    }
    #comments-list {
      flex: 1;
      overflow-y: auto;
      margin-bottom: 12px;
    }
    .comment-item {
      background: #2a2a2a;
      padding: 8px;
      border-radius: 6px;
      margin-bottom: 8px;
    }
    .comment-item .c-username {
      font-weight: bold;
      margin-bottom: 4px;
      cursor: pointer;
    }
    #new-comment {
      display: flex;
      gap: 8px;
    }
    #new-comment input {
      flex: 1;
      padding: 8px;
      border-radius: 6px;
      border: none;
      background: #2a2a2a;
      color: #eee;
    }
    #new-comment button {
      padding: 8px 12px;
      border: none;
      border-radius: 6px;
      background: #444;
      color: #fff;
      cursor: pointer;
    }
    #comments-close {
      position: absolute;
      top: 10px; right: 14px;
      background: none; border:none; font-size:1.4rem; color:#ccc; cursor:pointer;
    }
    /* Notifications modal */
    #notification-overlay.modal-overlay { align-items: flex-start; padding-top: 40px; }
    #notification-modal {
      background: #1f1f1f;
      padding: 20px;
      border-radius: 12px;
      width: 90%;
      max-width: 500px;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
      position: relative;
    }
    #notification-modal h3 {
      text-align: center;
      margin-bottom: 12px;
    }
    #notification-list {
      flex: 1;
      overflow-y: auto;
      margin-bottom: 12px;
    }
    .notification-item {
      background: #2a2a2a;
      padding: 8px;
      border-radius: 6px;
      margin-bottom: 8px;
      color: #eee;
      font-size: 0.9rem;
    }
    .notification-item .from-username {
      font-weight: bold;
      cursor: pointer;
    }
    #notification-close {
      position: absolute;
      top: 10px; right: 14px;
      background: none; border:none; font-size:1.4rem; color:#ccc; cursor:pointer;
    }
    /* Profile view badges */
    #profile-badges {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      margin-top: 10px;
    }
    #profile-badges img {
      width: 350px;
      height: auto;
    }
    /* 3-dot menu */
    .menu-btn {
      position: absolute;
      top: 16px; right: 16px;
      background: transparent; border: none; font-size: 1.5rem; color: #ccc;
      cursor: pointer;
    }
    .menu-options {
      position: absolute;
      top: 40px; right: 16px;
      background: #2a2a2a; border-radius: 6px; overflow: hidden;
      display: none;
    }
    .menu-options button {
      display: block;
      width: 100%;
      padding: 8px 12px;
      background: none; border:none; color:#eee; text-align:left;
      cursor: pointer;
    }
    .menu-options button:hover { background: #3a3a3a; }
    /* Back button */
    #back-btn {
      background: none; border:none; color:#aaa; cursor:pointer;
      margin-bottom: 12px;
    }
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Creepster&display=swap" rel="stylesheet">
</head>
<body>
  <!-- Login -->
  <div id="login-screen">
    <button id="login-btn">Sign in with Google</button>
  </div>

  <!-- Main feed -->
  <div id="app">
    <div class="section header">
      <h1>Ghost Story Hub</h1>
      <h2>horror story platform</h2>
      <div class="header-buttons">
        <button id="logout-btn" title="Logout">Logout</button>
        <button id="notification-btn" title="Notifications">
          <!-- Heroicons bell -->
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="24" height="24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 
                     00-4-5.659V5a2 2 0 10-4 0v.341C7.67 
                     6.165 6 8.388 6 11v3.159c0 .538-.214 
                     1.055-.595 1.436L4 17h5m6 0v1a3 3 0 
                     11-6 0v-1m6 0H9" />
          </svg>
        </button>
      </div>
    </div>
    <button id="post-story-btn">Post a story</button>
    <div id="posts"></div>
  </div>

  <!-- Profile view -->
  <div id="profile-view">
    <button id="back-btn">&larr; Back to feed</button>
    <div class="section">
      <button class="menu-btn">⋮</button>
      <div class="menu-options" id="menu-options"></div>
      <h1 id="profile-name"></h1>
      <div id="profile-badges"></div>
    </div>
    <div id="profile-posts"></div>
  </div>

  <!-- Story modal -->
  <div id="modal-overlay" class="modal-overlay">
    <div id="story-modal">
      <h3 style="margin-bottom:10px;">New Story</h3>
      <input type="text" id="story-title" placeholder="Title" />
      <textarea id="story-text" rows="5" placeholder="Full story..."></textarea>
      <button id="submit-story">Submit</button>
    </div>
  </div>

  <!-- Comments modal -->
  <div id="comments-overlay" class="modal-overlay">
    <div id="comments-modal">
      <button id="comments-close">&times;</button>
      <h3>Comments</h3>
      <div id="comments-list"></div>
      <div id="new-comment">
        <input type="text" id="comment-input" placeholder="Leave a comment…" />
        <button id="submit-comment">Post</button>
      </div>
    </div>
  </div>

  <!-- Notifications modal -->
  <div id="notification-overlay" class="modal-overlay">
    <div id="notification-modal">
      <button id="notification-close">&times;</button>
      <h3>Notifications</h3>
      <div id="notification-list"></div>
    </div>
  </div>

  <script>
    // Firebase init
    const firebaseConfig = {
      apiKey:    "AIzaSyDQDghMUXcjcLufG3xU94pUx-J0r9TUu6Q",
      authDomain:"gconnect-7fe65.firebaseapp.com",
      databaseURL:"https://gconnect-7fe65-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "gconnect-7fe65",
      storageBucket:"gconnect-7fe65.appspot.com",
      messagingSenderId:"484729292789",
      appId:     "1:484729292789:web:8e5391b09d3581c90b02bc"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    // Elements
    const loginScreen     = document.getElementById('login-screen');
    const loginBtn        = document.getElementById('login-btn');
    const appDiv          = document.getElementById('app');
    const postsDiv        = document.getElementById('posts');
    const postBtn         = document.getElementById('post-story-btn');
    const modalOverlay    = document.getElementById('modal-overlay');
    const submitStory     = document.getElementById('submit-story');
    const titleInput      = document.getElementById('story-title');
    const textInput       = document.getElementById('story-text');
    const commentsOverlay = document.getElementById('comments-overlay');
    const commentsList    = document.getElementById('comments-list');
    const commentInput    = document.getElementById('comment-input');
    const submitComment   = document.getElementById('submit-comment');
    const commentsClose   = document.getElementById('comments-close');
    const profileView     = document.getElementById('profile-view');
    const backBtn         = document.getElementById('back-btn');
    const profileName     = document.getElementById('profile-name');
    const logoutBtn       = document.getElementById('logout-btn');
    const notificationBtn = document.getElementById('notification-btn');
    const notificationOverlay = document.getElementById('notification-overlay');
    const notificationClose   = document.getElementById('notification-close');
    const notificationList    = document.getElementById('notification-list');

    // Authentication state observer
    auth.onAuthStateChanged(user => {
      if (user) {
        loginScreen.style.display = 'none';
        appDiv.style.display = 'block';
        profileView.style.display = 'none';
        loadPosts();
        loadNotifications();
      } else {
        appDiv.style.display = 'none';
        profileView.style.display = 'none';
        loginScreen.style.display = 'flex';
      }
    });

    // Google Sign-in
    loginBtn.addEventListener('click', () => {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider).catch(err => {
        console.error('Sign-in error', err);
      });
    });

    // Logout
    logoutBtn.addEventListener('click', () => {
      auth.signOut();
    });

    // Load posts from Firebase
    function loadPosts() {
      postsDiv.innerHTML = '';
      db.ref('posts').orderByChild('timestamp').limitToLast(100).on('value', snapshot => {
        postsDiv.innerHTML = '';
        const posts = [];
        snapshot.forEach(child => {
          posts.push({ id: child.key, ...child.val() });
        });
        // পুরানো থেকে নতুন: sort ascending timestamp
        posts.sort((a,b) => a.timestamp - b.timestamp);
        posts.forEach(post => {
          renderPost(post, postsDiv);
        });
      });
    }

    // Render a post element
    function renderPost(post, container) {
      const user = auth.currentUser;
      const div = document.createElement('div');
      div.classList.add('post');
      div.dataset.postId = post.id;

      // Username
      const uname = document.createElement('div');
      uname.classList.add('username');
      uname.textContent = post.username || 'Unknown';
      uname.addEventListener('click', () => {
        openProfile(post.userId, post.username);
      });
      div.appendChild(uname);

      // Title
      const titleEl = document.createElement('h3');
      titleEl.textContent = post.title;
      div.appendChild(titleEl);

      // Text
      const textEl = document.createElement('p');
      textEl.textContent = post.text;
      div.appendChild(textEl);

      // Footer with likes/comments
      const footer = document.createElement('div');
      footer.classList.add('post-footer');
      // Like button
      const likeBtn = document.createElement('button');
      likeBtn.classList.add('like-btn');
      likeBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" 
                   viewBox="0 0 24 24" stroke="currentColor" width="16" height="16">
                   <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                   d="M5 15l7-7 7 7" /></svg> Like`;
      // Check if current user already liked
      if (user) {
        db.ref(`likes/${post.id}/${user.uid}`).once('value').then(snap => {
          if (snap.exists()) {
            likeBtn.classList.add('active');
            likeBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" 
                     viewBox="0 0 24 24" stroke="currentColor" width="16" height="16">
                     <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                     d="M5 15l7-7 7 7" /></svg> Unlike`;
          }
        });
      }
      likeBtn.addEventListener('click', () => {
        if (!user) return;
        const likeRef = db.ref(`likes/${post.id}/${user.uid}`);
        likeRef.once('value').then(snap => {
          if (snap.exists()) {
            // Already liked: unlike
            likeRef.remove();
            likeBtn.classList.remove('active');
            likeBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" 
                         viewBox="0 0 24 24" stroke="currentColor" width="16" height="16">
                         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                         d="M5 15l7-7 7 7" /></svg> Like`;
          } else {
            // Add like
            likeRef.set(true).then(() => {
              likeBtn.classList.add('active');
              likeBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" 
                           viewBox="0 0 24 24" stroke="currentColor" width="16" height="16">
                           <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                           d="M5 15l7-7 7 7" /></svg> Unlike`;
              // Send notification to post owner if not self
              if (post.userId && user.uid !== post.userId) {
                const notifRef = db.ref(`notifications/${post.userId}`).push();
                notifRef.set({
                  type: 'like',
                  fromUserId: user.uid,
                  fromUsername: user.displayName,
                  postId: post.id,
                  postTitle: post.title,
                  timestamp: Date.now()
                });
              }
            });
          }
        });
      });
      footer.appendChild(likeBtn);

      // Comment button
      const commentBtn = document.createElement('button');
      commentBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" 
                     viewBox="0 0 24 24" stroke="currentColor" width="16" height="16">
                     <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                     d="M17 8h2a2 2 0 012 2v8l-4-4H7a2 2 0 01-2-2V10a2 2 0 012-2h2" /></svg> Comments`;
      commentBtn.addEventListener('click', () => {
        openComments(post.id);
      });
      footer.appendChild(commentBtn);

      div.appendChild(footer);
      // Prepend so newest appear on top
      container.prepend(div);
    }

    // Open new story modal
    postBtn.addEventListener('click', () => {
      modalOverlay.style.display = 'flex';
    });
    modalOverlay.addEventListener('click', e => {
      if (e.target === modalOverlay) modalOverlay.style.display = 'none';
    });
    submitStory.addEventListener('click', () => {
      const title = titleInput.value.trim();
      const text = textInput.value.trim();
      const user = auth.currentUser;
      if (title && text && user) {
        const newPostRef = db.ref('posts').push();
        newPostRef.set({
          userId: user.uid,
          username: user.displayName,
          title,
          text,
          timestamp: Date.now()
        }).then(() => {
          titleInput.value = '';
          textInput.value = '';
          modalOverlay.style.display = 'none';
        });
      }
    });

    // Open comments modal
    let currentPostId = null;
    function openComments(postId) {
      currentPostId = postId;
      commentsList.innerHTML = '';
      commentsOverlay.style.display = 'flex';
      // Load comments
      db.ref(`comments/${postId}`).on('value', snap => {
        commentsList.innerHTML = '';
        snap.forEach(child => {
          const c = child.val();
          const item = document.createElement('div');
          item.classList.add('comment-item');
          const uel = document.createElement('div');
          uel.classList.add('c-username');
          uel.textContent = c.username;
          uel.addEventListener('click', () => {
            openProfile(c.userId, c.username);
          });
          const tel = document.createElement('div');
          tel.textContent = c.text;
          item.appendChild(uel);
          item.appendChild(tel);
          commentsList.appendChild(item);
        });
      });
    }
    commentsClose.addEventListener('click', () => {
      commentsOverlay.style.display = 'none';
      // detach listener if desired
    });
    submitComment.addEventListener('click', () => {
      const text = commentInput.value.trim();
      const user = auth.currentUser;
      if (text && user && currentPostId) {
        const cRef = db.ref(`comments/${currentPostId}`).push();
        cRef.set({
          username: user.displayName,
          userId: user.uid,
          text,
          timestamp: Date.now()
        }).then(() => {
          commentInput.value = '';
        });
      }
    });

    // Notifications
    function loadNotifications() {
      const user = auth.currentUser;
      if (!user) return;
      // Load notifications for this user
      notificationList.innerHTML = '';
      db.ref(`notifications/${user.uid}`).on('value', snap => {
        notificationList.innerHTML = '';
        snap.forEach(child => {
          const note = child.val();
          const item = document.createElement('div');
          item.classList.add('notification-item');
          // Construct message based on type; for now only 'like'
          if (note.type === 'like') {
            // e.g., “Alice liked your post: My Horror Night”
            const usernameSpan = document.createElement('span');
            usernameSpan.classList.add('from-username');
            usernameSpan.textContent = note.fromUsername;
            usernameSpan.addEventListener('click', () => {
              openProfile(note.fromUserId, note.fromUsername);
            });
            // Text node parts
            const textBefore = document.createTextNode(' liked your post: ');
            const postTitleSpan = document.createElement('span');
            postTitleSpan.textContent = note.postTitle;
            postTitleSpan.style.fontStyle = 'italic';
            // Assemble
            item.appendChild(usernameSpan);
            item.appendChild(textBefore);
            item.appendChild(postTitleSpan);
          } else {
            // অন্য টাইপের নোটিফিকেশন হ্যান্ডেল করতে চাইলে এখানে যোগ করুন
            item.textContent = 'New notification';
          }
          notificationList.appendChild(item);
        });
      });
    }
    notificationBtn.addEventListener('click', () => {
      notificationOverlay.style.display = 'flex';
    });
    notificationOverlay.addEventListener('click', e => {
      if (e.target === notificationOverlay) notificationOverlay.style.display = 'none';
    });
    notificationClose.addEventListener('click', () => {
      notificationOverlay.style.display = 'none';
    });

    // Profile view
    function openProfile(userId, username) {
      profileView.style.display = 'block';
      appDiv.style.display = 'none';
      profileName.textContent = username;
      loadProfilePosts(userId);
      loadProfileBadges(userId);
    }
    backBtn.addEventListener('click', () => {
      profileView.style.display = 'none';
      appDiv.style.display = 'block';
    });
    function loadProfilePosts(userId) {
      const container = document.getElementById('profile-posts');
      container.innerHTML = '';
      db.ref('posts').orderByChild('userId').equalTo(userId).on('value', snap => {
        container.innerHTML = '';
        const posts = [];
        snap.forEach(child => {
          posts.push({ id: child.key, ...child.val() });
        });
        // Sort if needed by timestamp
        posts.sort((a,b) => a.timestamp - b.timestamp);
        posts.forEach(post => {
          renderPost(post, container);
        });
      });
    }
    function loadProfileBadges(userId) {
      const badgesDiv = document.getElementById('profile-badges');
      badgesDiv.innerHTML = '';
      // উদাহরণ: Firebase থেকে ব্যাজ ডেটা নিয়ে দেখানো
      // এখানে ডামি ইমেজ দেখানো হলো
      const img = document.createElement('img');
      img.src = 'badge-placeholder.png';
      img.alt = 'Badge';
      badgesDiv.appendChild(img);
    }
  </script>
</body>
  </html>
